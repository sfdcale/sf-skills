name: Validate Skills

on:
  push:
    branches: [main]
    paths:
      - '**/SKILL.md'
      - '**/.claude-plugin/plugin.json'
  pull_request:
    branches: [main]
    paths:
      - '**/SKILL.md'
      - '**/.claude-plugin/plugin.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate SKILL.md frontmatter
        run: |
          echo "üîç Validating Agent Skills frontmatter..."
          failed=0

          for skill in sf-apex sf-flow sf-diagram sf-metadata sf-data sf-deploy sf-ai-agentforce sf-connected-apps sf-integration skill-builder; do
            skill_file="./$skill/SKILL.md"

            if [ ! -f "$skill_file" ]; then
              echo "‚ùå $skill: SKILL.md not found at root"
              failed=1
              continue
            fi

            # Check for YAML frontmatter (starts with ---)
            if ! head -1 "$skill_file" | grep -q "^---"; then
              echo "‚ùå $skill: Missing YAML frontmatter"
              failed=1
              continue
            fi

            # Extract frontmatter
            frontmatter=$(sed -n '/^---$/,/^---$/p' "$skill_file" | head -20)

            # Check for required 'name' field
            if ! echo "$frontmatter" | grep -q "^name:"; then
              echo "‚ùå $skill: Missing 'name' field in frontmatter"
              failed=1
              continue
            fi

            # Check for required 'description' field
            if ! echo "$frontmatter" | grep -q "^description:"; then
              echo "‚ùå $skill: Missing 'description' field in frontmatter"
              failed=1
              continue
            fi

            # Validate name format (lowercase alphanumeric + hyphens, max 64 chars)
            name=$(echo "$frontmatter" | grep "^name:" | sed 's/name: *//')
            if ! echo "$name" | grep -qE "^[a-z0-9-]{1,64}$"; then
              echo "‚ùå $skill: Invalid name format '$name' (must be lowercase alphanumeric + hyphens, max 64 chars)"
              failed=1
              continue
            fi

            # Check name doesn't contain reserved words
            if echo "$name" | grep -qiE "(anthropic|claude)"; then
              echo "‚ùå $skill: Name contains reserved word (anthropic/claude)"
              failed=1
              continue
            fi

            echo "‚úÖ $skill: Valid frontmatter"
          done

          if [ $failed -eq 1 ]; then
            echo ""
            echo "‚ùå Some skills failed validation"
            exit 1
          fi
          echo ""
          echo "‚úÖ All skills have valid frontmatter"

      - name: Validate plugin.json sync
        run: |
          echo "üîÑ Checking plugin.json sync with SKILL.md..."
          chmod +x scripts/validate-sync.sh
          ./scripts/validate-sync.sh
